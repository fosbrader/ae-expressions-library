---
interface Props {
  code: string;
  filename?: string;
}

const { code, filename = 'expression.jsx' } = Astro.props;
const escapeHtml = (text: string) =>
  text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

const applyTokenColors = (text: string) =>
  text
    .replace(/(["'`].*?["'`])/g, '<span class="token string">$1</span>')
    .replace(/\b(-?\d+(?:\.\d+)?)\b/g, '<span class="token number">$1</span>')
    .replace(
      /\b(const|let|var|return|if|else|for|while|function|new|this|true|false|null|undefined)\b/g,
      '<span class="token keyword">$1</span>'
    )
    .replace(/\b([A-Za-z_]\w*)(?=\s*\()/g, '<span class="token function">$1</span>');

const findCommentIndex = (line: string) => {
  let inString: string | null = null;
  let escapedChar = false;

  for (let i = 0; i < line.length; i += 1) {
    const char = line[i];

    if (escapedChar) {
      escapedChar = false;
      continue;
    }

    if (char === '\\') {
      escapedChar = true;
      continue;
    }

    if (!inString && char === '/' && line[i + 1] === '/') {
      return i;
    }

    if (char === '"' || char === "'" || char === '`') {
      inString = inString === char ? null : char;
    }
  }

  return -1;
};

const highlightLine = (line: string) => {
  const commentIndex = findCommentIndex(line);

  if (commentIndex !== -1) {
    const codePart = line.slice(0, commentIndex);
    const commentPart = line.slice(commentIndex);

    return `${applyTokenColors(escapeHtml(codePart))}<span class="token comment">${escapeHtml(
      commentPart
    )}</span>`;
  }

  return applyTokenColors(escapeHtml(line));
};

const highlightedLines = code
  .trim()
  .split('\n')
  .map((line) => highlightLine(line));
---

<div class="code-section">
  <div class="code-header">
    <span class="code-filename">{filename}</span>
    <button class="code-copy-btn" data-code={code}>ðŸ“‹ Copy</button>
  </div>
  
  <div class="code-block">
    <pre><code>{highlightedLines.map((line) => (
      <span class="code-line" set:html={line}></span>
    ))}</code></pre>
  </div>
</div>

<script>
  const buttons = document.querySelectorAll('.code-copy-btn');
  buttons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      const code = btn.getAttribute('data-code') || '';
      try {
        await navigator.clipboard.writeText(code);
        btn.textContent = 'âœ“ Copied';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'ðŸ“‹ Copy';
          btn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        btn.textContent = 'âŒ Failed';
        setTimeout(() => {
          btn.textContent = 'ðŸ“‹ Copy';
        }, 2000);
      }
    });
  });
</script>
