---
import '../styles/global.css';
import Search from '../components/Search.astro';
import categories from '../data/categories.json';
import projects from '../data/projects.json';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  activeTab?: string;
  showBreadcrumb?: boolean;
  breadcrumbPath?: string;
}

const { title, activeTab, showBreadcrumb = false, breadcrumbPath = '' } = Astro.props;
const baseRaw = import.meta.env.BASE_URL;
const base = baseRaw.endsWith('/') ? baseRaw : baseRaw + '/';

const expressions = await getCollection('expressions');
const expressionCount = expressions.length;
const lastUpdated = new Date().toLocaleDateString('en-US', { 
  year: 'numeric', 
  month: 'short', 
  day: 'numeric' 
});

// Group expressions by type for sidebar
const groupedExpressions: Record<string, typeof expressions> = {};
expressions.forEach(expr => {
  const type = expr.data.expressionTypes[0] || 'utility';
  if (!groupedExpressions[type]) {
    groupedExpressions[type] = [];
  }
  groupedExpressions[type].push(expr);
});

// Version tracking
const siteVersion = "0.2.0";
const buildDate = new Date().toISOString().split('T')[0];
const isDev = import.meta.env.DEV;
const versionDisplay = isDev ? `${siteVersion}-dev` : siteVersion;

// Terminal messages
const terminalMessages = [
  "Ready to animate.",
  "No keyframes harmed.",
  "Expression engine: online.",
  "Expressions loaded.",
];
const randomMessage = terminalMessages[Math.floor(Math.random() * terminalMessages.length)];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title} ‚Äî AE Expressions</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="ide-window">
    <!-- Mobile Header -->
    <header class="mobile-header">
      <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Open menu">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      </button>
      <span class="mobile-title">AE Expressions</span>
      <button class="mobile-search-btn" id="mobile-search-btn" aria-label="Search">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.25 0a8.25 8.25 0 0 0-6.18 13.72L1 22.88l1.12 1.12 8.05-9.12A8.251 8.251 0 1 0 15.25.01V0zm0 15a6.75 6.75 0 1 1 0-13.5 6.75 6.75 0 0 1 0 13.5z"/></svg>
      </button>
    </header>
    
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <!-- Title Bar -->
    <header class="titlebar">
      <div class="titlebar-traffic-lights">
        <span class="traffic-light close"></span>
        <span class="traffic-light minimize"></span>
        <span class="traffic-light maximize"></span>
      </div>
      <nav class="titlebar-menu">
        <span class="titlebar-menu-item">File</span>
        <span class="titlebar-menu-item">Edit</span>
        <span class="titlebar-menu-item">View</span>
        <span class="titlebar-menu-item">Go</span>
        <span class="titlebar-menu-item">Help</span>
      </nav>
      <span class="titlebar-title">AE Expressions Library ‚Äî {title}</span>
    </header>
    
    <div class="ide-main">
      <!-- Activity Bar -->
      <aside class="activitybar">
        <div class="activitybar-top">
          <a href={`${base}`} class={`activitybar-icon ${activeTab === 'home' ? 'active' : ''}`} title="Explorer">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M17.5 0h-9L7 1.5V6H2.5L1 7.5v15.07L2.5 24h12.07L16 22.57V18h4.7l1.3-1.43V4.5L17.5 0zm0 2.12l2.38 2.38H17.5V2.12zm-3 20.38h-12v-15H7v9.07L8.5 18h6v4.5zm6-6h-12v-15H16v4.5h4.5v10.5z"/></svg>
          </a>
          <a href={`${base}all/`} class={`activitybar-icon ${activeTab === 'all' ? 'active' : ''}`} title="Search">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M15.25 0a8.25 8.25 0 0 0-6.18 13.72L1 22.88l1.12 1.12 8.05-9.12A8.251 8.251 0 1 0 15.25.01V0zm0 15a6.75 6.75 0 1 1 0-13.5 6.75 6.75 0 0 1 0 13.5z"/></svg>
          </a>
        </div>
        <div class="activitybar-bottom">
          <span class="activitybar-icon" title="Settings">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.85 8.75l4.15.83v4.84l-4.15.83 2.35 3.52-3.43 3.43-3.52-2.35-.83 4.15H9.58l-.83-4.15-3.52 2.35-3.43-3.43 2.35-3.52L0 13.42V8.58l4.15-.83L1.8 4.23 5.23 1.8l3.52 2.35L9.58 0h4.84l.83 4.15 3.52-2.35 3.43 3.43-2.35 3.52zM12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
          </span>
        </div>
      </aside>
      
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">Explorer</div>
        <nav class="sidebar-content">
          <ul class="file-tree">
            <!-- Expressions section -->
            <li class="tree-section">
              <div class="tree-section-header">
                <span class="tree-chevron">‚Ä∫</span>
                <span>Expressions</span>
              </div>
              <ul class="tree-children">
                {Object.entries(groupedExpressions).map(([typeId, exprs]) => {
                  const typeInfo = categories.expressionTypes.find(t => t.id === typeId);
                  return (
                    <li class="tree-folder">
                      <div class="tree-folder-header">
                        <span class="tree-chevron">‚Ä∫</span>
                        <svg class="folder-svg" width="16" height="16" viewBox="0 0 16 16" fill="#dcb67a"><path d="M14.5 3H7.71l-.85-.85L6.51 2h-5l-.5.5v11l.5.5h13l.5-.5v-10L14.5 3zm-.51 8.49V13h-12V3h4.29l.85.85.36.15H14v7.49z"/></svg>
                        <span class="folder-label">{typeInfo?.label || typeId}</span>
                      </div>
                      <ul class="tree-folder-children">
                        {exprs.map(expr => (
                          <li>
                            <a 
                              href={`${base}expressions/${expr.slug}/`}
                              class={`tree-file ${activeTab === expr.slug ? 'active' : ''}`}
                            >
                              <svg class="file-svg" width="16" height="16" viewBox="0 0 16 16" fill="#f0db4f"><path d="M10 0L6 0 0 6v9.5l.5.5h15l.5-.5v-15L10 0zm4 15H2V6.5L5.5 3H14v12z"/></svg>
                              <span class="file-name">{expr.data.title}</span>
                            </a>
                          </li>
                        ))}
                      </ul>
                    </li>
                  );
                })}
              </ul>
            </li>
            
            <!-- Projects section -->
            <li class="tree-section">
              <div class="tree-section-header">
                <span class="tree-chevron">‚Ä∫</span>
                <span>Projects</span>
              </div>
              <ul class="tree-children">
                {projects.projects.map(proj => (
                  <li>
                    <a 
                      href={`${base}projects/${proj.id}/`} 
                      class={`tree-file ${activeTab === `project-${proj.id}` ? 'active' : ''}`}
                    >
                      <svg class="file-svg" width="16" height="16" viewBox="0 0 16 16" fill="#6997d5"><path d="M14.5 3H7.71l-.85-.85L6.51 2h-5l-.5.5v11l.5.5h13l.5-.5v-10L14.5 3zm-.51 8.49V13h-12V3h4.29l.85.85.36.15H14v7.49z"/></svg>
                      <span class="file-name">{proj.name}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </li>
          </ul>
        </nav>
      </aside>
      
      <!-- Editor Group -->
      <main class="editor-group">
        <!-- Tabs -->
        <div class="tabs-bar">
          <div class={`tab ${activeTab === 'home' ? 'active' : ''}`}>
            <span class="tab-icon">üìÑ</span>
            <span>Welcome</span>
          </div>
          {activeTab && activeTab !== 'home' && activeTab !== 'all' && (
            <div class="tab active">
              <span class="tab-icon">‚óá</span>
              <span>{title}.jsx</span>
              <span class="tab-close">√ó</span>
            </div>
          )}
          {activeTab === 'all' && (
            <div class="tab active">
              <span class="tab-icon">üîç</span>
              <span>All Expressions</span>
              <span class="tab-close">√ó</span>
            </div>
          )}
        </div>
        
        <!-- Breadcrumb -->
        {showBreadcrumb && (
          <div class="breadcrumb-bar">
            <a href={`${base}`}>expressions</a>
            <span class="breadcrumb-sep">‚Ä∫</span>
            <span>{breadcrumbPath || title}</span>
          </div>
        )}
        
        <!-- Editor Content -->
        <div class="editor-content">
          <slot />
        </div>
      </main>
    </div>
    
    <!-- Panel (Terminal) -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-tabs">
          <span class="panel-tab active">Terminal</span>
          <span class="panel-tab">Output</span>
          <span class="panel-tab">Problems</span>
        </div>
        <div class="panel-actions">
          <span class="panel-action">‚àí</span>
          <span class="panel-action">‚ñ°</span>
          <span class="panel-action">√ó</span>
        </div>
      </div>
      <div class="panel-content">
        <div class="terminal-line">
          <span class="terminal-prompt">~/expressions</span>
          <span class="terminal-cmd">$ status</span>
        </div>
        <div class="terminal-output terminal-success">‚úì {randomMessage}</div>
        <div class="terminal-output terminal-info">üì¶ Version: {versionDisplay} (built {buildDate})</div>
        <div class="terminal-output terminal-info">üìä {expressionCount} expressions loaded</div>
        <div class="terminal-output">üí° Press ‚åòK to search</div>
        <div class="terminal-output" style="margin-top: 8px; color: var(--text-muted); font-style: italic;">
          Happily vibe-coded by Brad using Opus 4.5 in Cursor ‚ú®
        </div>
        <div class="terminal-line" style="margin-top: 8px;">
          <span class="terminal-prompt">~/expressions</span>
          <span class="terminal-cmd">$ <span id="cursor">_</span></span>
        </div>
      </div>
    </div>
    
    <!-- Status Bar -->
    <footer class="statusbar">
      <div class="statusbar-left">
        <span class="statusbar-item">üåø main</span>
        <span class="statusbar-item">‚ü≥ synced</span>
      </div>
      <div class="statusbar-right">
        <span class="statusbar-item">{expressionCount} expressions</span>
        <span class="statusbar-item">JavaScript JSX</span>
        <span class="statusbar-item">UTF-8</span>
      </div>
    </footer>
  </div>
  
  <Search base={base} />
  
  <script>
    // Section toggle
    document.querySelectorAll('.tree-section-header').forEach(header => {
      header.addEventListener('click', () => {
        header.parentElement?.classList.toggle('open');
      });
    });
    
    // Folder toggle
    document.querySelectorAll('.tree-folder-header').forEach(header => {
      header.addEventListener('click', () => {
        header.parentElement?.classList.toggle('open');
      });
    });
    
    // Blinking cursor
    const cursor = document.getElementById('cursor');
    if (cursor) {
      setInterval(() => {
        cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
      }, 530);
    }
    
    // Command palette shortcut
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('palette-input')?.focus();
        document.getElementById('command-palette')?.classList.add('open');
      }
    });
    
    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    mobileMenuBtn?.addEventListener('click', () => {
      sidebar?.classList.toggle('open');
      overlay?.classList.toggle('open');
    });
    
    overlay?.addEventListener('click', () => {
      sidebar?.classList.remove('open');
      overlay?.classList.remove('open');
    });
    
    // Close sidebar when clicking a link (mobile)
    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          sidebar?.classList.remove('open');
          overlay?.classList.remove('open');
        }
      });
    });
    
    // Mobile search button
    const mobileSearchBtn = document.getElementById('mobile-search-btn');
    mobileSearchBtn?.addEventListener('click', () => {
      document.getElementById('command-palette')?.classList.add('open');
      document.getElementById('palette-input')?.focus();
    });
  </script>
</body>
</html>
