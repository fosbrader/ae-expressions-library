---
import IDELayout from '../../layouts/IDELayout.astro';
import { getCollection } from 'astro:content';
import versionData from '../../data/version.json';
import projects from '../../data/projects.json';

const baseRaw = import.meta.env.BASE_URL;
const base = baseRaw.endsWith('/') ? baseRaw : baseRaw + '/';

const expressions = await getCollection('expressions');
const recentExpressions = [...expressions]
  .sort((a, b) => new Date(b.data.dateAdded).getTime() - new Date(a.data.dateAdded).getTime())
  .slice(0, 5);
---

<IDELayout title="Admin Dashboard" isAdmin={true}>
  <div class="dashboard-grid">
    <div class="dashboard-stats">
      <div class="stat-card">
        <div class="stat-value">{expressions.length}</div>
        <div class="stat-label">Expressions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{projects.projects.length}</div>
        <div class="stat-label">Projects</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">v{versionData.public}</div>
        <div class="stat-label">Public Version</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">{versionData.deployCount}</div>
        <div class="stat-label">Deploys</div>
      </div>
    </div>
    
    <div class="dashboard-row">
      <div class="admin-card" style="flex: 1;">
        <div class="admin-card-header">Recent Expressions</div>
        <div class="admin-card-body" style="padding: 0;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Type</th>
                <th>Added</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {recentExpressions.map(expr => (
                <tr>
                  <td>{expr.data.title}</td>
                  <td><span class="admin-badge">{expr.data.expressionTypes[0]}</span></td>
                  <td>{expr.data.dateAdded}</td>
                  <td>
                    <a href={`${base}admin/expressions/${expr.data.id}/`} class="admin-btn admin-btn-secondary" style="padding: 4px 8px; font-size: 11px;">
                      Edit
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="admin-card" style="width: 300px;">
        <div class="admin-card-header">Quick Actions</div>
        <div class="admin-card-body">
          <a href={`${base}admin/expressions/new/`} class="admin-btn admin-btn-primary" style="width: 100%; justify-content: center; margin-bottom: 8px;">
            + New Expression
          </a>
          <a href={`${base}`} target="_blank" class="admin-btn admin-btn-secondary" style="width: 100%; justify-content: center;">
            üåê View Live Site
          </a>
          <p style="font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center;">
            Changes auto-push to GitHub on save
          </p>
        </div>
      </div>
    </div>
  </div>
</IDELayout>

<style>
  .dashboard-grid {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .dashboard-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  
  .stat-card {
    background: var(--bg-panel);
    border: 1px solid var(--border-panel);
    border-radius: 4px;
    padding: 20px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 28px;
    font-weight: 600;
    color: var(--accent-lightblue);
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .dashboard-row {
    display: flex;
    gap: 16px;
  }
</style>
