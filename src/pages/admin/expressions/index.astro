---
import IDELayout from '../../../layouts/IDELayout.astro';
import { getCollection } from 'astro:content';
import categories from '../../../data/categories.json';

const baseRaw = import.meta.env.BASE_URL;
const base = baseRaw.endsWith('/') ? baseRaw : baseRaw + '/';

const expressions = await getCollection('expressions');
const sortedExpressions = [...expressions].sort(
  (a, b) => new Date(b.data.dateAdded).getTime() - new Date(a.data.dateAdded).getTime()
);
---

<IDELayout title="All Expressions" isAdmin={true}>
  <div class="page-header">
    <a href={`${base}admin/expressions/new/`} class="admin-btn admin-btn-primary">
      + New Expression
    </a>
  </div>
  
  <div class="admin-card">
    <div class="admin-card-body" style="padding: 0;">
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Type</th>
            <th>Layer</th>
            <th>Complexity</th>
            <th>Validation</th>
            <th>Added</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {sortedExpressions.map(expr => {
            const typeInfo = categories.expressionTypes.find(t => t.id === expr.data.expressionTypes[0]);
            const layerInfo = categories.layerTypes.find(l => l.id === expr.data.layerType);
            const complexityInfo = categories.complexityLevels.find(c => c.id === expr.data.complexity);
            return (
              <tr>
                <td><code style="font-size: 11px; color: var(--text-muted);">{expr.data.id}</code></td>
                <td>
                  <strong>{expr.data.title}</strong>
                  <div style="font-size: 11px; color: var(--text-muted);">{expr.slug}</div>
                </td>
                <td><span class="admin-badge">{typeInfo?.label || expr.data.expressionTypes[0]}</span></td>
                <td>{layerInfo?.label || expr.data.layerType}</td>
                <td>
                  <span class="admin-badge" style={`background: ${complexityInfo?.color}22; color: ${complexityInfo?.color};`}>
                    {complexityInfo?.icon} {complexityInfo?.label}
                  </span>
                </td>
                <td>
                  <span class={`admin-badge ${expr.data.validated ? 'admin-badge-success' : 'admin-badge-warning'}`}>
                    {expr.data.validated ? expr.data.validatedBy : 'Unvalidated'}
                  </span>
                </td>
                <td>{expr.data.dateAdded}</td>
                <td>
                  <div style="display: flex; gap: 4px;">
                    <a href={`${base}admin/expressions/${expr.data.id}/`} class="admin-btn admin-btn-secondary" style="padding: 4px 8px; font-size: 11px;">
                      Edit
                    </a>
                    <a href={`${base}expressions/${expr.slug}/`} target="_blank" class="admin-btn admin-btn-secondary" style="padding: 4px 8px; font-size: 11px;">
                      View
                    </a>
                  </div>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  </div>
</IDELayout>

<style>
  .page-header {
    margin-bottom: 16px;
    display: flex;
    justify-content: flex-end;
  }
</style>
